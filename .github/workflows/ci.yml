  name: CI

  env:
    DOTNET_VERSION: '8.0'
    AZURE_WEBAPP_NAME: 'app-dometrain-github-actions-isakov-dev'

  on:
    push:
      branches: [ "main" ]

  jobs:
    build:
      name: CI
      runs-on: ubuntu-latest

      steps:
        - uses: actions/checkout@v4

        - name: Set up .NET Core
          uses: actions/setup-dotnet@v4
          with:
            dotnet-version: ${{ env.DOTNET_VERSION }}

        - name: Dotnet run tests
          run: dotnet test --configuration Release

        - name: Dotnet publish
          run: dotnet publish src/GitHubActionsDotNet.Api/GitHubActionsDotNet.Api.csproj --configuration Release -o artifacts

        - name: Upload artifact
          uses: actions/upload-artifact@v4
          with:
            name: dometrain-artifact
            path: artifacts/

    deploy_dev:
      name: Deploy Dev
      runs-on: ubuntu-latest
      needs: build

      steps:
        - name: Download artifact
          uses: actions/download-artifact@v4
          with:
            name: dometrain-artifact
            path: artifacts2/

        - name: Azure login
          uses: azure/login@v2
          with:
            client-id: ${{ secrets.AZURE_CLIENT_ID }}
            tenant-id: ${{ secrets.AZURE_TENANT_ID }}
            subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

        - name: 'Deploy to Azure App Service'
          uses: azure/webapps-deploy@v2
          with:
            app-name: ${{ env.AZURE_WEBAPP_NAME }} # Replace with your app name
            package: artifacts2/

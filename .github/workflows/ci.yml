  name: CI

  env:
    DOTNET_VERSION: '8.0'
    AZURE_WEBAPP_NAME: 'app-dometrain-github-actions-isakov-dev'
    PROD_AZURE_WEBAPP_NAME: 'app-dometrain-github-actions-isakov-prod'

  on:
    push:
      branches: [ "main" ]

  permissions:
    id-token: write
    contents: read

  jobs:
    build:
      name: CI
      runs-on: ubuntu-latest

      steps:
        - uses: actions/checkout@v4

        - name: Set up .NET Core
          uses: actions/setup-dotnet@v4
          with:
            dotnet-version: ${{ env.DOTNET_VERSION }}

        - name: Dotnet run tests
          run: dotnet test --configuration Release

        - name: Dotnet publish
          run: dotnet publish src/GitHubActionsDotNet.Api/GitHubActionsDotNet.Api.csproj --configuration Release -o artifacts

        - name: Upload artifact
          uses: actions/upload-artifact@v4
          with:
            name: dometrain-artifact
            path: artifacts/

    deploy_dev:
      name: Deploy Dev
      needs: build
      uses: ./.github/workflows/step-deploy.yml
      with:
        env: dev
      secrets:
        AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
        AZURE_AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        AZURE_AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    deploy_prod:
      name: Deploy Prod
      needs: build
      uses: ./.github/workflows/step-deploy.yml
      with:
        env: prod
